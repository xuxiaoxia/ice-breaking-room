<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>破冰馆 - 102 完整机关版 (Z轴修正)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #ffffff; font-family: 'Microsoft YaHei', sans-serif; touch-action: none; user-select: none; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background-color: #ff0000; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 100; opacity: 0.8;
        }
        #blocker {
            position: absolute; width: 100%; height: 100%;
            background-color: rgba(255,255,255,0.9); display: flex;
            justify-content: center; align-items: center; color: #333;
            text-align: center; cursor: pointer; z-index: 999;
        }
        #joystick-container {
            position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px;
            background: rgba(0,0,0,0.05); border-radius: 50%; display: none; border: 2px solid rgba(0,0,0,0.1);
        }
        #joystick-knob {
            position: absolute; top: 35px; left: 35px; width: 50px; height: 50px;
            background: rgba(0,0,0,0.2); border-radius: 50%; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="crosshair"></div>
    <div id="blocker">
        <div id="instructions">
            <strong>[ 102 现场勘探 ]</strong><br/><br/>
            <span>PC端：点击进入 | WASD 移动 | 鼠标转向 | 左键开门/遮光板</span><br/>
            <span>手机端：左侧摇杆移动 | 右侧滑动转向 | 右侧点击开门/遮光板</span>
        </div>
    </div>
    
    <div id="joystick-container"><div id="joystick-knob"></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xD8EDF2);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(10, 1.6, 0); 
        camera.rotation.order = 'YXZ'; 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 1.2); 
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
        sunLight.position.set(10, 20, 10);
        scene.add(sunLight);
        const pointLight = new THREE.PointLight(0xffffff, 0.6, 15);
        camera.add(pointLight);
        scene.add(camera);

        const matteGrayMaterial = new THREE.MeshStandardMaterial({
            color: 0x555555, metalness: 0.0, roughness: 1.0, side: THREE.DoubleSide
        });

        const loader = new THREE.GLTFLoader();
        let roomModel;
        const interactiveDoors = [];
        const interactiveShutters = []; 
        const objectsToCollide = [];

        loader.load('room102.glb', (gltf) => {
            roomModel = gltf.scene;
            scene.add(roomModel);
            roomModel.traverse((child) => {
                if (child.isMesh) {
                    if (child.name.includes('Shutter')) {
                        // 如果是遮光板，给它单独赋予一个颜色（比如暗红色 0x8b0000）
                        child.material = new THREE.MeshStandardMaterial({ 
                            color: 0x444444, 
                            metalness: 0.2, 
                            roughness: 0.8 
                        });
                    } else if (child.name.includes('Text')) {
                        // 【新增黑科技】：精准拦截招牌，赋予幽蓝金属材质！
                        child.material = new THREE.MeshStandardMaterial({ 
                            color: 0x2b5797,   // 幽蓝色 (你可以把 2b5797 换成任何十六进制颜色码)
                            metalness: 0.8,   // 强烈的金属质感 (0到1之间)
                            roughness: 0.6     // 表面光滑度，越低越反光 (0到1之间)
                        });
                    } else if (child.name.includes('Window_Glass')) {
                        // 【终极抗光版】：拔掉感光神经，强行显示冰蓝色
                        child.material = new THREE.MeshBasicMaterial({
                            color: 0x55aaff,       // 冰蓝色
                            transparent: true,     // 开启透明通道
                            opacity: 0.4,          // 40% 实体颜色，60% 透过白光
                            side: THREE.DoubleSide // 双面显示
                        });
                    } else if (child.name.includes('Room') || child.name.includes('Door_')){
                        // 其他墙壁和门，照常涂成工业灰
                        child.material = matteGrayMaterial; 
                    }
                    objectsToCollide.push(child);
                }
                if (child.name.includes('Door')) {
                    child.userData.isOpen = false; 
                    child.userData.baseRotationY = child.rotation.y;
                    child.userData.targetRotationY = child.rotation.y; 
                    interactiveDoors.push(child);
                }
                if (child.name.includes('Shutter')) {
                    child.userData.isSlid = false;
                    // 【关键修复】：将获取的初始坐标改为 Z 轴
                    child.userData.basePosZ = child.position.z;
                    child.userData.targetPosZ = child.position.z;
                    interactiveShutters.push(child);
                }
            });
        });

        const controls = new THREE.PointerLockControls(camera, document.body);
        const blocker = document.getElementById('blocker');
        const joyContainer = document.getElementById('joystick-container');
        const knob = document.getElementById('joystick-knob');
        
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        blocker.addEventListener('click', () => { 
            if (!isMobile) controls.lock(); 
            blocker.style.display = 'none';
            if (isMobile) joyContainer.style.display = 'block';
        });
        controls.addEventListener('lock', () => { blocker.style.display = 'none'; });
        controls.addEventListener('unlock', () => { if(!isMobile) blocker.style.display = 'flex'; });

        const raycaster = new THREE.Raycaster();
        function triggerInteract() {
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const intersects = raycaster.intersectObjects(roomModel ? roomModel.children : [], true);
            
            if (intersects.length > 0) {
                let obj = intersects[0].object;

                let shutterObj = obj;
                while(shutterObj.parent && !shutterObj.name.includes('Shutter')) {
                    if(shutterObj.parent.type === 'Scene') break; shutterObj = shutterObj.parent;
                }
                if (shutterObj.name.includes('Shutter')) {
                    if (!shutterObj.userData.isSlid) {
                        // 【关键修复】：沿着 Z 轴滑动 0.8 米
                        shutterObj.userData.targetPosZ = shutterObj.userData.basePosZ - 0.8;
                        shutterObj.userData.isSlid = true;
                    } else {
                        shutterObj.userData.targetPosZ = shutterObj.userData.basePosZ;
                        shutterObj.userData.isSlid = false;
                    }
                    return; 
                }

                let doorObj = obj;
                while(doorObj.parent && !doorObj.name.includes('Door')) {
                    if(doorObj.parent.type === 'Scene') break; doorObj = doorObj.parent;
                }
                if (doorObj.name.includes('Door')) {
                    
                    // 【这就是新增的超能力代码】
                    let swingDir = doorObj.name.includes('Rev') ? 1 : -1;
                    
                    doorObj.userData.targetRotationY = !doorObj.userData.isOpen ? 
                        doorObj.userData.baseRotationY + swingDir * (Math.PI / 4) : doorObj.userData.baseRotationY; 
                    doorObj.userData.isOpen = !doorObj.userData.isOpen;
                }


            }
        }
        window.addEventListener('mousedown', (e) => { if (!isMobile && controls.isLocked && e.button === 0) triggerInteract(); });

        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        document.addEventListener('keydown', (e) => {
            if(e.code==='KeyW') moveForward=true; if(e.code==='KeyS') moveBackward=true;
            if(e.code==='KeyA') moveLeft=true; if(e.code==='KeyD') moveRight=true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.code==='KeyW') moveForward=false; if(e.code==='KeyS') moveBackward=false;
            if(e.code==='KeyA') moveLeft=false; if(e.code==='KeyD') moveRight=false;
        });

        let touchMoveId = null, touchLookId = null;
        let lastTouchX, lastTouchY;
        let touchStartTime, touchStartX, touchStartY;

        window.addEventListener('touchstart', (e) => {
            if (!isMobile) return;
            for(let t of e.changedTouches) {
                if(t.pageX < window.innerWidth / 2) {
                    touchMoveId = t.identifier;
                } else {
                    touchLookId = t.identifier; 
                    lastTouchX = t.pageX; lastTouchY = t.pageY;
                    touchStartTime = Date.now(); touchStartX = t.pageX; touchStartY = t.pageY;
                }
            }
        });

        window.addEventListener('touchmove', (e) => {
            if (!isMobile) return;
            for(let t of e.changedTouches) {
                if(t.identifier === touchMoveId) {
                    let dx = t.pageX - 110, dy = t.pageY - (window.innerHeight - 110);
                    let dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
                    let angle = Math.atan2(dy, dx);
                    knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                    
                    let joyY = Math.sin(angle) * (dist/50);
                    let joyX = Math.cos(angle) * (dist/50);
                    moveForward = joyY < -0.2; moveBackward = joyY > 0.2;
                    moveLeft = joyX < -0.2; moveRight = joyX > 0.2;
                }
                if(t.identifier === touchLookId) {
                    camera.rotation.y -= (t.pageX - lastTouchX) * 0.005;
                    camera.rotation.x -= (t.pageY - lastTouchY) * 0.005;
                    camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                    lastTouchX = t.pageX; lastTouchY = t.pageY;
                }
            }
        });

        window.addEventListener('touchend', (e) => {
            if (!isMobile) return;
            for(let t of e.changedTouches) {
                if(t.identifier === touchMoveId) {
                    moveForward = false; moveBackward = false; moveLeft = false; moveRight = false;
                    knob.style.transform = 'translate(0,0)'; touchMoveId = null;
                }
                if(t.identifier === touchLookId) {
                    let dt = Date.now() - touchStartTime;
                    let moveDist = Math.abs(t.pageX - touchStartX) + Math.abs(t.pageY - touchStartY);
                    if (dt < 250 && moveDist < 10) triggerInteract();
                    touchLookId = null;
                }
            }
        });

        let prevTime = performance.now();
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            
            if (controls.isLocked || isMobile) {
                const delta = (time - prevTime) / 1000;
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                const playerDir = new THREE.Vector3();
                camera.getWorldDirection(playerDir);
                playerDir.y = 0; playerDir.normalize();

                const checkCollision = (dir) => {
                    raycaster.set(camera.position, dir);
                    const hits = raycaster.intersectObjects(objectsToCollide, false);
                    return hits.length > 0 && hits[0].distance < 0.8;
                };

                if (moveForward && !checkCollision(playerDir)) velocity.z -= direction.z * 40.0 * delta;
                if (moveBackward && !checkCollision(playerDir.clone().negate())) velocity.z -= direction.z * 40.0 * delta;
                if (moveLeft && !checkCollision(playerDir.clone().applyAxisAngle(new THREE.Vector3(0,1,0), Math.PI/2))) velocity.x -= direction.x * 40.0 * delta;
                if (moveRight && !checkCollision(playerDir.clone().applyAxisAngle(new THREE.Vector3(0,1,0), -Math.PI/2))) velocity.x -= direction.x * 40.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
            }

            interactiveDoors.forEach(door => {
                door.rotation.y = THREE.MathUtils.lerp(door.rotation.y, door.userData.targetRotationY, 0.1);
            });

            // 【关键修复】：应用 Z 轴的阻尼滑动动画
            interactiveShutters.forEach(shutter => {
                shutter.position.z = THREE.MathUtils.lerp(shutter.position.z, shutter.userData.targetPosZ, 0.1);
            });

            prevTime = time;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>